<template>
  <modal
    class="modal-document-container"
    @close="close()">
    <template #body>
      <div v-if="pdfViewer"
        class="toolbar">
        Show raw text
        <i v-if="showTextViewer === false" class="fa fa-lg fa-fw fa-toggle-off" @click="toggle" />
        <i v-if="showTextViewer === true" class="fa fa-lg fa-fw fa-toggle-on" @click="toggle" />
      </div>
      <div ref="content">
        Loading...
      </div>
      <div>
        <hr>
        <table v-if="documentData && textOnly">
          <tr>
            <td class="doc-label">Publication Date</td>
            <td>{{ dateFormatter(documentData.publication_date.date, 'YYYY-MM-DD') }}</td>
          </tr>
          <tr>
            <td class="doc-label">Publisher</td>
            <td class="doc-value">{{ documentData.publisher_name }}</td>
          </tr>
          <tr>
            <td class="doc-label">Author</td>
            <td class="doc-value">{{ documentData.author }}</td>
          </tr>
          <tr>
            <td class="doc-label">Locations</td>
            <td class="doc-value">{{ documentData.ner_analytics.loc.join(', ') }} </td>
          </tr>
          <tr>
            <td class="doc-label">Organizations</td>
            <td class="doc-value">{{ documentData.ner_analytics.org.join(', ') }}</td>
          </tr>
        </table>
      </div>
    </template>
    <template #footer>
      <div>
        <button
          class="btn btn-md btn-primary"
          @click="close()"
        >Close</button>
        <button
          v-if="$route.name === 'kbExplorer'"
          class="btn btn-md btn-primary"
          @click="addToSearch()"
        >Add to search</button>
      </div>
    </template>
  </modal>
</template>

<script>
import API from '@/api/api';
import Modal from '@/components/modals/modal';
import { mapActions } from 'vuex';
import { createPDFViewer } from '@/utils/pdf/viewer';
import { removeChildren } from '@/utils/dom-util';
import dateFormatter from '@/formatters/date-formatter';

const isPdf = (data) => {
  const fileType = data && data.file_type;
  return fileType === 'pdf' || fileType === 'application/pdf';
};

const reformat = (v) => {
  return `<span class='extract-text-anchor' style='background: #56b3e9'>${v}</span>`;
};

// Run through a list of sucessive transform to try to find the correct match
const lossySearch = (text, textFragment) => {
  let fragment = textFragment;
  fragment = fragment.replaceAll(' .', '.');
  if (text.search(fragment) >= 0) return text.replace(fragment, reformat(fragment));

  fragment = fragment.replaceAll(' ;', ';');
  if (text.search(fragment) >= 0) return text.replace(fragment, reformat(fragment));

  fragment = fragment.replaceAll(' ,', ',');
  if (text.search(fragment) >= 0) return text.replace(fragment, reformat(fragment));

  return text;
};


const createTextViewer = (text) => {
  const el = document.createElement('div');
  const originalText = text;

  function search(textFragment) {
    let t = originalText;
    if (textFragment) {
      if (text.search(textFragment) >= 0) {
        t = t.replace(textFragment, reformat(textFragment));
      } else {
        t = lossySearch(t, textFragment);
      }
      el.innerHTML = t;
      const anchor = document.getElementsByClassName('extract-text-anchor')[0];
      if (anchor) {
        const scroller = document.getElementsByClassName('modal-body')[0];
        scroller.scrollTop = anchor.offsetTop - 100;
      }
    }
  }

  el.innerHTML = originalText;
  el.style.paddingTop = '30px';
  el.style.paddingLeft = '15px';
  el.style.paddingRight = '15px';
  el.style.paddingBottom = '15px';

  return {
    search,
    element: el
  };
};

export default {
  name: 'ModalDocument',
  components: {
    Modal
  },
  props: {
    documentId: {
      type: String,
      required: true
    },
    textFragment: {
      type: String,
      default: null
    }
  },
  data: () => ({
    documentData: null,
    textViewer: null,
    pdfViewer: null,
    textOnly: false,
    showTextViewer: false
  }),
  mounted() {
    this.refresh();
  },
  methods: {
    ...mapActions({
      addSearchTerm: 'query/addSearchTerm'
    }),
    dateFormatter,
    refresh() {
      this.fetchReaderContent();
    },
    async fetchReaderContent() {
      const url = `documents/${this.documentId}`;
      this.documentData = (await API.get(url)).data;
      this.textViewer = createTextViewer(this.documentData.extracted_text);

      if (isPdf(this.documentData)) {
        const rawDocUrl = `/api/dart/${this.documentId}/raw`;
        try {
          this.pdfViewer = await createPDFViewer({ url: rawDocUrl });
        } catch (_) {
          this.textOnly = true;
        }
      } else {
        this.textOnly = true;
      }

      removeChildren(this.$refs.content);
      if (this.textOnly === true) {
        this.$refs.content.appendChild(this.textViewer.element);
        if (this.textFragment) {
          this.textViewer.search(this.textFragment);
        }
      } else {
        this.$refs.content.appendChild(this.pdfViewer.element);
        if (this.textFragment) {
          this.pdfViewer.search(this.textFragment);
        }
      }
    },
    toggle() {
      this.showTextViewer = !this.showTextViewer;

      removeChildren(this.$refs.content);
      if (this.showTextViewer === true) {
        this.$refs.content.appendChild(this.textViewer.element);
      } else {
        this.$refs.content.appendChild(this.pdfViewer.element);
      }
    },
    addToSearch() {
      this.addSearchTerm({
        field: 'docId',
        term: this.documentId
      });
      this.close();
    },
    close() {
      this.$emit('close', null);
    }
  }
};
</script>

<style lang="scss" scoped>
.modal-document-container {

  .doc-label {
    vertical-align: baseline;
    width: 220px;
    text-align: right;
    padding: 1px 3px;
    font-weight: 600;
  }

  .doc-value {
    text-align: left;
    padding: 1px 3px;
    max-width: 400px;
  }

  ::v-deep(.modal-container) {
    padding: 0;
    width: 800px;

    .modal-header{
      display: none;
    }

    .modal-footer {
      display: flex;
      justify-content: center;
    }
    .modal-body {
      padding: 0;
      margin: 0;
      height: 80vh;
      overflow-y: auto;
    }
  }
  .toolbar {
    padding: 5px;
  }

  /* Bootstrap sets all box-sizing to border-box, which messes up the pdf-js library */
  ::v-deep(.page) {
    box-sizing: content-box !important;
  }

}
</style>
